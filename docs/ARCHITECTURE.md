# 系统架构设计

## 🏗️ 整体架构概览

### 技术栈
- **后端**: Python 3.8+ with Flask/Django (可选)
- **数据库**: MySQL 8.0+ on port 3309 with PyMySQL connector
- **前端**: HTML5/CSS3/JavaScript with PyEcharts/Plotly
- **数据获取**: akshare for real-time stock data
- **模板引擎**: Jinja2 for server-side rendering
- **图表库**: PyEcharts 2.0.3, Plotly 5.18.0
- **数据处理**: Pandas 2.1.4, NumPy 1.24.4

### 架构分层
```
┌─────────────────────────────────────────────┐
│                 表现层 (Presentation)        │
│  ┌─────────────┐  ┌─────────────┐           │
│  │   HTML UI   │  │   Charts    │           │
│  └─────────────┘  └─────────────┘           │
└─────────────────────────────────────────────┘
┌─────────────────────────────────────────────┐
│               业务逻辑层 (Business Logic)    │
│  ┌─────────────┐  ┌─────────────┐           │
│  │  Dashboard  │  │ Data Processor │        │
│  └─────────────┘  └─────────────┘           │
└─────────────────────────────────────────────┘
┌─────────────────────────────────────────────┐
│               数据访问层 (Data Access)       │
│  ┌─────────────┐  ┌─────────────┐           │
│  │  Database   │  │  akshare API │          │
│  └─────────────┘  └─────────────┘           │
└─────────────────────────────────────────────┘
┌─────────────────────────────────────────────┐
│               数据存储层 (Data Storage)      │
│  ┌─────────────┐                            │
│  │   MySQL     │                            │
│  └─────────────┘                            │
└─────────────────────────────────────────────┘
```

## 📦 核心组件

### 1. 主应用程序 (main_enhanced.py)
**职责**: 协调所有模块，处理用户请求，生成最终输出

**主要功能**:
- 初始化数据库连接
- 加载和预处理数据
- 调用各功能模块
- 生成HTML模板
- 启动Web服务器（如适用）

### 2. 数据库操作类 (database.py)
**职责**: 封装所有MySQL CRUD操作

**核心方法**:
- `connect()` / `disconnect()` - 连接管理
- `insert_*()` / `update_*()` - 数据写入
- `get_*()` / `query()` - 数据查询
- `batch_insert_*()` - 批量操作
- `initialize_database()` - 数据库初始化

### 3. 数据库配置 (database_config.py)
**职责**: 集中管理数据库配置和表结构定义

**包含内容**:
- 连接配置（生产/测试环境）
- 表结构定义
- 数据验证规则
- 连接池配置

### 4. 应用配置 (config.py)
**职责**: 管理应用程序的运行时配置

**配置项**:
- 颜色主题和样式
- 数据源设置
- 图表配置
- 功能开关

## 🔄 数据流架构

### 数据流动过程
```
1. 数据源 → 
2. database.py (PyMySQL连接器) → 
3. 数据类型转换 (_convert_db_data()) →
4. EnhancedStockDashboard 处理数据 → 
5. 生成HTML模板 → 
6. PyEcharts/Plotly 渲染图表 → 
7. 输出到 output/ 目录
```

### 数据类型转换流程
由于 PyMySQL 返回 Decimal 和 datetime 类型，必须进行转换：

```python
def _convert_db_data(data):
    """
    转换数据库返回的数据类型：
    - Decimal → float
    - datetime/date → string (YYYY-MM-DD)
    - 保持其他类型不变
    """
    if isinstance(data, dict):
        return {k: _convert_value(v) for k, v in data.items()}
    elif isinstance(data, list):
        return [_convert_db_data(item) for item in data]
    return data
```

## 🗃️ 数据模型设计

### 主要数据表

#### 1. 市场情绪指标 (market_sentiment)
- **主键**: date
- **核心指标**: 涨停数、跌停数、封板率、破板率
- **进阶指标**: 连板成功率、昨日涨停今日收益

#### 2. 连板个股数据 (limitup_events) 
- **索引**: date, ticker, board_level
- **个股信息**: 代码、名称、板数、成交额
- **特征标识**: 是否一字板、是否反包、题材行业

#### 3. 题材热度数据 (theme_daily)
- **复合主键**: date + theme_name
- **热度指标**: 涨幅、热度评分、连任天数
- **领涨股**: 存储为JSON数组

#### 4. 行业排名数据 (industry_daily)
- **复合主键**: date + industry_name  
- **排名指标**: 排名、涨幅、强度评分
- **资金流向**: 净主力流入、成交额

## 🎯 功能模块

### 四大核心功能

#### 1. 连板天梯 (Ladder)
- 显示不同板数的个股分布
- 支持按板数、题材、市场过滤
- 个股卡片包含详细信息

#### 2. 大盘情绪 (Sentiment) 
- 多维度市场情绪指标
- 热力图显示行业表现
- 多折线对比历史趋势

#### 3. 题材热度 (Themes)
- 题材表现墙和排名表
- 热度趋势图表
- 领涨股信息

#### 4. 行业追踪 (Industry)
- 行业排名卡片
- 名次变化路径图
- 强弱分布可视化

## 🔧 开发架构原则

### 1. 模块化设计
- 每个功能模块独立实现
- 清晰的接口定义
- 低耦合高内聚

### 2. 配置驱动
- 所有配置集中管理
- 支持多环境配置
- 易于修改和扩展

### 3. 错误处理
- 统一的错误处理机制
- 数据库操作异常捕获
- 友好的错误提示

### 4. 性能考虑
- 数据库连接池
- 数据缓存机制
- 批量操作优化

## 🚀 部署架构

### 开发环境
```
前端浏览器 ←→ Python应用服务器 ←→ MySQL数据库
```

### 生产环境建议
```
负载均衡器 ←→ 应用服务器集群 ←→ MySQL主从复制
                    ↑
                缓存服务器(Redis)
```

## 📊 监控与日志

### 日志记录
- 数据库操作日志
- 错误和异常日志
- 性能监控日志

### 健康检查
- 数据库连接状态检查
- 服务可用性检查
- 数据完整性检查

## 🔄 数据流程示例

### 页面请求处理流程
1. 用户访问页面
2. 应用初始化并连接数据库
3. 查询相关数据表
4. 数据类型转换和处理
5. 生成图表配置和数据
6. 渲染HTML模板
7. 返回最终页面

### 数据更新流程
1. 定时任务触发数据获取
2. 从akshare API获取最新数据
3. 数据清洗和格式化
4. 批量插入到数据库
5. 更新缓存（如适用）
6. 记录操作日志

这个架构设计确保了系统的可扩展性、可维护性和性能，同时保持了各组件之间的清晰边界。